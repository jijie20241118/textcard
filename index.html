<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mori Card - æç®€æ–‡å­—å¡ç‰‡åˆ‡åˆ†å™¨</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Ma+Shan+Zheng&family=Noto+Serif+SC:wght@200;400;700&family=ZCOOL+KuaiLe&family=ZCOOL+XiaoWei&family=Inter:wght@200;400&display=swap" rel="stylesheet">
    <style>
        body {
            background: linear-gradient(135deg, #e1f0e3 0%, #c1e0c2 50%, #ecf5e6 100%);
            min-height: 100vh;
            font-family: 'Inter', sans-serif;
            color: #1a2e1a;
        }
        .glass-panel {
            background: rgba(255, 255, 255, 0.85);
            backdrop-filter: blur(25px);
            border-right: 1px solid rgba(255, 255, 255, 0.4);
            box-shadow: 4px 0 24px rgba(0,0,0,0.05);
        }
        .custom-scrollbar::-webkit-scrollbar { width: 5px; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #81c784; border-radius: 10px; }
        
        /* Fixed size for card preview */
        .card-preview {
            width: 320px;
            height: 568px;
            position: relative;
            overflow: hidden;
            box-shadow: 0 20px 40px -10px rgba(0, 0, 0, 0.15);
            transition: transform 0.3s ease;
            background-color: white;
        }
        .card-content-area {
            white-space: pre-wrap;
            word-break: break-all;
            width: 100%;
            height: 100%;
            display: flex;
            transition: all 0.3s ease;
        }
        input[type="range"] {
            accent-color: #166534;
        }
        .btn-active {
            background: white !important;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
            color: #166534 !important;
            font-weight: bold;
        }
        .ui-text-label {
            font-size: 11px;
            font-weight: 700;
            color: #2d4a2d;
            letter-spacing: 0.05em;
            margin-bottom: 6px;
            display: block;
        }
        .card-action-btn {
            background: rgba(255,255,255,0.8);
            backdrop-filter: blur(4px);
            border: 1px solid rgba(0,0,0,0.05);
            transition: all 0.2s;
        }
        .card-action-btn:hover {
            background: white;
            transform: scale(1.1);
        }
        .btn-delete:hover {
            color: #ef4444;
            border-color: #fee2e2;
        }
    </style>
</head>
<body class="overflow-hidden">

    <div id="app" class="flex flex-col h-screen">
        <!-- Header -->
        <header class="h-16 px-6 flex items-center justify-between z-30 shrink-0 border-b border-white/30 bg-white/20 backdrop-blur-md">
            <div class="flex items-center gap-3">
                <div class="p-2 bg-green-800 shadow-md rounded-lg text-white">
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M17.7 7.7A7.1 7.1 0 1 1 5 13.1"/><path d="m7 21 7.9-6.3"/><path d="m11 21 4.7-9.4"/><path d="m14 21 2.1-4.2"/></svg>
                </div>
                <div class="flex flex-col">
                    <span class="text-sm font-black tracking-widest text-green-900 leading-none">MORI CARD</span>
                    <span class="text-[9px] font-bold tracking-[0.25em] text-green-700/70 uppercase">Forest Aesthetic</span>
                </div>
            </div>
            <button onclick="downloadAllCards()" id="downloadBtn" class="flex items-center gap-2 px-6 py-2.5 bg-green-800 text-white rounded-full text-xs font-bold shadow-lg hover:bg-green-900 active:scale-95 transition-all">
                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v4"/><polyline points="7 10 12 15 17 10"/><line x1="12" x2="12" y1="15" y2="3"/></svg>
                <span>æ‰¹é‡å¯¼å‡ºé«˜æ¸…å›¾</span>
            </button>
        </header>

        <div class="flex flex-1 overflow-hidden">
            <!-- Sidebar: Width increased to 384px (w-96) -->
            <aside class="w-96 glass-panel flex flex-col overflow-y-auto shrink-0 z-20 custom-scrollbar p-6 space-y-7">
                
                <!-- Split Strategy -->
                <section>
                    <label class="ui-text-label uppercase">æ‹†åˆ†æ¨¡å¼</label>
                    <div class="grid grid-cols-3 gap-1 p-1 bg-green-900/10 rounded-xl border border-green-900/5">
                        <button onclick="setSplitMode('separator')" class="mode-btn btn-active py-2 rounded-lg text-[10px]" data-mode="separator">ç¬¦å· (---)</button>
                        <button onclick="setSplitMode('newline')" class="mode-btn text-green-900/50 py-2 rounded-lg text-[10px]" data-mode="newline">æŒ‰è¡Œæ‹†åˆ†</button>
                        <button onclick="setSplitMode('length')" class="mode-btn text-green-900/50 py-2 rounded-lg text-[10px]" data-mode="length">å›ºå®šé•¿åº¦</button>
                    </div>
                </section>

                <!-- Input Text -->
                <section>
                    <label class="ui-text-label uppercase">å†…å®¹ç¼–è¾‘</label>
                    <textarea 
                        id="mainInput"
                        oninput="handleInput()"
                        class="w-full h-32 p-4 bg-white shadow-inner rounded-xl text-sm outline-none focus:ring-2 focus:ring-green-700/20 transition-all border border-green-900/5 placeholder:text-stone-300"
                        placeholder="è¾“å…¥æ–‡å­—ï¼Œç³»ç»Ÿå°†æ ¹æ®ç­–ç•¥è‡ªåŠ¨ç”Ÿæˆå¡ç‰‡..."
                    ></textarea>
                </section>

                <!-- Typography -->
                <section class="space-y-5">
                    <label class="ui-text-label uppercase">ç‰ˆé¢æ§åˆ¶</label>
                    
                    <div>
                        <span class="text-[10px] text-green-800/60 font-bold block mb-2">è‰ºæœ¯å­—ä½“</span>
                        <select onchange="updateStyle('fontFamily', this.value)" class="w-full bg-white p-2.5 rounded-xl border border-green-900/10 text-xs outline-none cursor-pointer shadow-sm">
                            <option value="sans-serif">ç®€çº¦é»‘ä½“ (Modern)</option>
                            <option value="'Noto Serif SC', serif" selected>æ¸©æŸ”å®‹ä½“ (Serif)</option>
                            <option value="'Ma Shan Zheng', cursive">æ²»æ„ˆæ¥·ä½“ (Script)</option>
                            <option value="'ZCOOL KuaiLe', cursive">ç«¥è¶£åœ†ä½“ (Rounded)</option>
                            <option value="'ZCOOL XiaoWei', serif">è¯—æ„æ‰‹å†™ (Handwriting)</option>
                        </select>
                    </div>

                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <div class="flex justify-between text-[10px] font-bold text-green-900/70 mb-2">
                                <span>å­—å·</span>
                                <span id="fontSizeVal">24px</span>
                            </div>
                            <input type="range" min="12" max="100" value="24" oninput="updateStyle('fontSize', this.value + 'px')" class="w-full h-1 bg-green-200 rounded-lg appearance-none">
                        </div>
                        <div>
                            <div class="flex justify-between text-[10px] font-bold text-green-900/70 mb-2">
                                <span>è¾¹è·</span>
                                <span id="paddingVal">40px</span>
                            </div>
                            <input type="range" min="0" max="120" value="40" oninput="updateStyle('padding', this.value + 'px')" class="w-full h-1 bg-green-200 rounded-lg appearance-none">
                        </div>
                    </div>

                    <!-- Alignment Controls -->
                    <div class="space-y-3">
                        <span class="text-[10px] text-green-800/60 font-bold block">æ°´å¹³ä¸å‚ç›´å¯¹é½</span>
                        <div class="flex gap-1 bg-green-900/10 p-1 rounded-xl border border-green-900/5">
                            <button onclick="updateStyle('textAlign', 'left')" class="align-h-btn flex-1 py-2 flex justify-center hover:bg-white rounded-lg transition-all text-green-900/30" data-val="left"><svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><path d="M17 10H3M21 6H3M21 14H3M17 18H3"/></svg></button>
                            <button onclick="updateStyle('textAlign', 'center')" class="align-h-btn btn-active flex-1 py-2 flex justify-center hover:bg-white rounded-lg transition-all text-green-900/30" data-val="center"><svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><path d="M18 10H6M21 6H3M21 14H3M18 18H6"/></svg></button>
                            <button onclick="updateStyle('textAlign', 'right')" class="align-h-btn flex-1 py-2 flex justify-center hover:bg-white rounded-lg transition-all text-green-900/30" data-val="right"><svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><path d="M21 10H7M21 6H3M21 14H3M21 18H7"/></svg></button>
                        </div>
                        <div class="flex gap-1 bg-green-900/10 p-1 rounded-xl border border-green-900/5">
                            <button onclick="updateStyle('alignItems', 'flex-start')" class="align-v-btn flex-1 py-2 flex flex-col items-center gap-1 hover:bg-white rounded-lg transition-all text-green-900/30" data-val="flex-start"><svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><path d="m4 6 16 0M4 10h12M4 14h8"/></svg><span class="text-[8px] font-bold">ç½®é¡¶</span></button>
                            <button onclick="updateStyle('alignItems', 'center')" class="align-v-btn btn-active flex-1 py-2 flex flex-col items-center gap-1 hover:bg-white rounded-lg transition-all text-green-900/30" data-val="center"><svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><path d="M4 12h16M8 8h8M10 16h4"/></svg><span class="text-[8px] font-bold">å±…ä¸­</span></button>
                            <button onclick="updateStyle('alignItems', 'flex-end')" class="align-v-btn flex-1 py-2 flex flex-col items-center gap-1 hover:bg-white rounded-lg transition-all text-green-900/30" data-val="flex-end"><svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><path d="M4 18h16M8 14h12M12 10h8"/></svg><span class="text-[8px] font-bold">ç½®åº•</span></button>
                        </div>
                    </div>
                </section>

                <!-- Background -->
                <section class="pb-10 space-y-4">
                    <label class="ui-text-label uppercase">å…¨å±€è‰²å½©ä¸çº¹ç†</label>
                    <div class="grid grid-cols-2 gap-3">
                        <div class="p-3 bg-white rounded-xl border border-green-900/5 shadow-sm">
                            <span class="text-[9px] font-black text-green-800/40 block mb-1">æ–‡å­—é¢œè‰²</span>
                            <input type="color" value="#1a202c" oninput="updateStyle('color', this.value)" class="w-full h-6 rounded cursor-pointer border-none bg-transparent">
                        </div>
                        <div class="p-3 bg-white rounded-xl border border-green-900/5 shadow-sm">
                            <span class="text-[9px] font-black text-green-800/40 block mb-1">å¡ç‰‡åº•è‰²</span>
                            <input type="color" value="#ffffff" oninput="updateStyle('backgroundColor', this.value)" class="w-full h-6 rounded cursor-pointer border-none bg-transparent">
                        </div>
                    </div>
                    
                    <div class="space-y-2 p-3 bg-white rounded-xl border border-green-900/5 shadow-sm">
                        <div class="flex justify-between text-[10px] font-bold text-green-900/70">
                            <span>å…¨å±€åº•å›¾ä¸é€æ˜åº¦</span>
                            <span id="bgOpacityVal">40%</span>
                        </div>
                        <input type="range" min="0" max="100" value="40" oninput="updateStyle('backgroundOpacity', this.value / 100)" class="w-full h-1 bg-green-200 rounded-lg appearance-none">
                    </div>

                    <div class="relative group h-24 rounded-2xl border-2 border-dashed border-green-300/50 bg-white/40 flex flex-col items-center justify-center hover:bg-white/80 cursor-pointer overflow-hidden transition-all">
                        <svg class="opacity-40 text-green-800" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect width="18" height="18" x="3" y="3" rx="2" ry="2"/><circle cx="9" cy="9" r="2"/><path d="m21 15-3.086-3.086a2 2 0 0 0-2.828 0L6 21"/></svg>
                        <span class="text-[10px] font-bold mt-2 text-green-900/60">ä¸Šä¼ é»˜è®¤åº•å›¾</span>
                        <input type="file" onchange="handleBgUpload(event, 'global')" accept="image/*" class="absolute inset-0 opacity-0 cursor-pointer">
                        <div id="bgPreview" class="absolute inset-0 hidden"><img class="w-full h-full object-cover"></div>
                    </div>
                </section>
            </aside>

            <!-- Main Preview: Cards are fixed size and centered in grid -->
            <main class="flex-1 p-8 md:p-12 overflow-y-auto custom-scrollbar">
                <div id="cardsGrid" class="flex flex-wrap gap-10 pb-40 justify-center">
                    <!-- Cards will be injected here -->
                </div>
            </main>
        </div>
    </div>

    <script>
        let splitMode = 'separator';
        let cardSpecificBgs = {}; 
        let currentStyle = {
            fontFamily: "'Noto Serif SC', serif",
            fontSize: '24px',
            color: '#1a202c',
            backgroundColor: '#ffffff',
            padding: '40px',
            textAlign: 'center',
            alignItems: 'center',
            lineHeight: '1.6',
            letterSpacing: '0em',
            backgroundImage: 'none',
            backgroundOpacity: 0.4
        };

        const defaultText = "æ£®å¡ (Mori Card)\n---\nå¸ƒå±€ä¼˜åŒ–æ›´æ–°ã€‚\n\nå·¦ä¾§æ§åˆ¶æ å·²åŠ å®½ï¼Œ\nå³ä¾§å¡ç‰‡å°ºå¯¸å·²å›ºå®šï¼ˆ320Ã—568ï¼‰ã€‚\n---\nè¿™ç§å›ºå®šæ¯”ä¾‹ç¡®ä¿äº†\nå¯¼å‡ºçš„å›¾ç‰‡åœ¨æ‰‹æœºç«¯æµè§ˆæ—¶\nå…·æœ‰å®Œç¾çš„è§†è§‰æ¯”ä¾‹ã€‚";
        
        window.onload = () => {
            document.getElementById('mainInput').value = defaultText;
            renderCards();
        };

        function setSplitMode(mode) {
            splitMode = mode;
            document.querySelectorAll('.mode-btn').forEach(btn => {
                if(btn.dataset.mode === mode) btn.classList.add('btn-active');
                else btn.classList.remove('btn-active');
            });
            renderCards();
        }

        function handleInput() {
            renderCards();
        }

        function getChunks(text) {
            if (!text.trim()) return [];
            if (splitMode === 'separator') return text.split('---').map(s => s.trim()).filter(s => s !== '');
            if (splitMode === 'newline') return text.split('\n').map(s => s.trim()).filter(s => s !== '');
            if (splitMode === 'length') {
                const chunks = [];
                for (let i = 0; i < text.length; i += 80) chunks.push(text.slice(i, i + 80));
                return chunks;
            }
            return [text];
        }

        function updateStyle(prop, val) {
            currentStyle[prop] = val;
            if (prop === 'fontSize') document.getElementById('fontSizeVal').innerText = val;
            if (prop === 'padding') document.getElementById('paddingVal').innerText = val;
            if (prop === 'backgroundOpacity') document.getElementById('bgOpacityVal').innerText = Math.round(val * 100) + '%';
            
            if (prop === 'textAlign') {
                document.querySelectorAll('.align-h-btn').forEach(b => {
                    b.dataset.val === val ? b.classList.add('btn-active') : b.classList.remove('btn-active');
                });
            }
            if (prop === 'alignItems') {
                document.querySelectorAll('.align-v-btn').forEach(b => {
                    b.dataset.val === val ? b.classList.add('btn-active') : b.classList.remove('btn-active');
                });
            }
            renderCards();
        }

        function handleBgUpload(e, type, index) {
            const file = e.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = (ev) => {
                    const imgData = ev.target.result;
                    if(type === 'global') {
                        currentStyle.backgroundImage = imgData;
                        const preview = document.getElementById('bgPreview');
                        preview.classList.remove('hidden');
                        preview.querySelector('img').src = imgData;
                    } else {
                        cardSpecificBgs[index] = imgData;
                    }
                    renderCards();
                };
                reader.readAsDataURL(file);
            }
        }

        function deleteSpecificBg(index) {
            delete cardSpecificBgs[index];
            renderCards();
        }

        function renderCards() {
            const text = document.getElementById('mainInput').value;
            const chunks = getChunks(text);
            const grid = document.getElementById('cardsGrid');
            grid.innerHTML = '';

            chunks.forEach((chunk, i) => {
                const cardWrapper = document.createElement('div');
                cardWrapper.className = 'flex flex-col gap-3 group';
                
                const card = document.createElement('div');
                card.className = 'card-preview rounded-2xl';
                card.id = `card-${i}`;
                card.style.backgroundColor = currentStyle.backgroundColor;

                const bgOverlay = document.createElement('div');
                bgOverlay.className = 'absolute inset-0 bg-cover bg-center transition-all mix-blend-multiply';
                bgOverlay.style.opacity = currentStyle.backgroundOpacity;
                
                const specificBg = cardSpecificBgs[i];
                if(specificBg) {
                    bgOverlay.style.backgroundImage = `url(${specificBg})`;
                } else if(currentStyle.backgroundImage !== 'none') {
                    bgOverlay.style.backgroundImage = `url(${currentStyle.backgroundImage})`;
                }
                
                const content = document.createElement('div');
                content.className = 'card-content-area relative z-10';
                content.innerText = chunk;
                
                content.style.fontFamily = currentStyle.fontFamily;
                content.style.fontSize = currentStyle.fontSize;
                content.style.color = currentStyle.color;
                content.style.padding = currentStyle.padding;
                content.style.textAlign = currentStyle.textAlign;
                content.style.alignItems = currentStyle.alignItems;
                content.style.lineHeight = currentStyle.lineHeight;
                
                const r = parseInt(currentStyle.backgroundColor.slice(1,3), 16);
                const g = parseInt(currentStyle.backgroundColor.slice(3,5), 16);
                const b = parseInt(currentStyle.backgroundColor.slice(5,7), 16);
                const brightness = (r * 299 + g * 587 + b * 114) / 1000;
                content.style.textShadow = brightness > 200 ? 'none' : '0 1px 3px rgba(0,0,0,0.2)';

                const actions = document.createElement('div');
                actions.className = 'absolute bottom-4 right-4 z-20 flex gap-2 opacity-0 group-hover:opacity-100 transition-opacity';
                
                if (specificBg) {
                    const delBtn = document.createElement('button');
                    delBtn.className = 'card-action-btn btn-delete w-8 h-8 rounded-full flex items-center justify-center shadow-lg';
                    delBtn.onclick = () => deleteSpecificBg(i);
                    delBtn.innerHTML = `<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><path d="M3 6h18M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/></svg>`;
                    actions.appendChild(delBtn);
                }

                const uploadBtn = document.createElement('label');
                uploadBtn.className = 'card-action-btn w-8 h-8 rounded-full flex items-center justify-center cursor-pointer shadow-lg';
                uploadBtn.innerHTML = `<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="#166534" stroke-width="2.5"><rect width="18" height="18" x="3" y="3" rx="2" ry="2"/><circle cx="9" cy="9" r="2"/><path d="m21 15-3.086-3.086a2 2 0 0 0-2.828 0L6 21"/></svg>`;
                const uploadInput = document.createElement('input');
                uploadInput.type = 'file';
                uploadInput.className = 'hidden';
                uploadInput.onchange = (e) => handleBgUpload(e, 'specific', i);
                uploadBtn.appendChild(uploadInput);
                actions.appendChild(uploadBtn);

                card.appendChild(bgOverlay);
                card.appendChild(content);
                card.appendChild(actions);
                
                const footer = document.createElement('div');
                footer.className = 'flex justify-between items-center px-2 opacity-50 transition-opacity group-hover:opacity-100';
                footer.style.width = '320px';
                footer.innerHTML = `
                    <span class="text-[10px] font-black text-green-900 tracking-tighter uppercase italic">Mori Studio</span>
                    <span class="text-[10px] font-bold text-green-950 bg-white/60 px-2 py-0.5 rounded-full shadow-sm">PAGE ${i+1}</span>
                `;

                cardWrapper.appendChild(card);
                cardWrapper.appendChild(footer);
                grid.appendChild(cardWrapper);
            });
        }

        async function downloadAllCards() {
            const btn = document.getElementById('downloadBtn');
            const originalHTML = btn.innerHTML;
            btn.disabled = true;
            btn.innerHTML = '<span class="animate-spin">ğŸŒ€</span> <span>é«˜æ¸…æ¸²æŸ“ä¸­...</span>';

            const cards = document.querySelectorAll('.card-preview');
            for (let i = 0; i < cards.length; i++) {
                const actions = cards[i].querySelector('.group-hover\\:opacity-100');
                if(actions) actions.style.display = 'none';

                const canvas = await html2canvas(cards[i], {
                    scale: 3,
                    useCORS: true,
                    backgroundColor: currentStyle.backgroundColor,
                    logging: false,
                    width: 320,
                    height: 568
                });
                
                if(actions) actions.style.display = 'flex';

                const link = document.createElement('a');
                link.download = `mori-card-${i+1}.png`;
                link.href = canvas.toDataURL('image/png');
                link.click();
                await new Promise(r => setTimeout(r, 600));
            }
            btn.disabled = false;
            btn.innerHTML = originalHTML;
        }
    </script>
</body>
</html>
